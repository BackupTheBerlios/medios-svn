#! /bin/bash

# simple configure script
# writen by wireddd
# You can use it, but you can't sell it.

# this is the function that asks the yes or no questions
function CONFIG_QUERY_YN {
CONFIGURE_OPTION=$1
if [ $CONFIGURE_OPTION = -1 ]
	then
		USERSELECTION=""
		while [ $CONFIGURE_OPTION == -1 ]; do
			echo ""
			echo "-----------------------------------------"
			echo ""
			if [ ! $USERSELECTION = "" ]; then
				echo -n "'$USERSELECTION' is not a valid selection. "
			fi
			echo $2
			echo -n "Choose y or n [$3]: "
			read -e USERSELECTION
			if [ "$USERSELECTION" == "" ]; then
				if [ $3 == "y" ]; then
					CONFIGURE_OPTION="1"
				fi
				if [ $3 == "n" ]; then
					CONFIGURE_OPTION="0"
				fi
			else
				if [ $USERSELECTION == "y" ]; then
					CONFIGURE_OPTION="1"
				fi
				if [ $USERSELECTION == "n" ]; then
					CONFIGURE_OPTION="0"
				fi
			fi
		done
fi
return $CONFIGURE_OPTION
}


# check if the file this script generates exists so we don't overwrite something
if [ -f "./Makefile.conf" ]
	then
		echo -n "Makefile.conf exists, replace? y/n (n):"
		read -e USERSELECTION
		if [ "$USERSELECTION" == "" ]; then
			exit
		else
			if [ $USERSELECTION == "n" ]; then
				exit
			fi
			if [ $USERSELECTION == "y" ]; then
				mv Makefile.conf Makefile.conf.bak
				echo "Makefile.conf has been moved to Makefile.conf.bak"
			fi
		fi
		HAVE_CONFIG_FILE=1
	else
		HAVE_CONFIG_FILE=0
fi

#init the variables that we are going to ask the user to set
CONFIGURE_TARGET_DEVICE=-1
CONFIGURE_CHK_BAT_POWER=-1
CONFIGURE_CHK_USB_FW=-1
CONFIGURE_HAVE_EXT_MODULE=-1
CONFIGURE_HAVE_FM_REMOTE=-1
CONFIGURE_HAVE_MAS_SOUND=-1
CONFIGURE_HAVE_AIC23_SOUND=-1
CONFIGURE_HAVE_CMD_LINE=-1
CONFIGURE_HAVE_EVT=-1
CONFIGURE_HAVE_DVR=-1

# this is the first configuration question, AV3XX or GMINI4XX
if [ $CONFIGURE_TARGET_DEVICE = -1 ]
	then
		USERSELECTION=""
		while [ $CONFIGURE_TARGET_DEVICE = -1 ]; do
			echo "-----------------------------------------"
			echo ""
			if [ ! $USERSELECTION = "" ]; then
				echo -n "'$USERSELECTION' is not a valid selection. "
			fi
			echo "Please pick a target device"
			echo "1	AV3XX"
			echo "2	GMINI4XX"
			echo -n "Choose 1 or 2 [1]: "
			read -e USERSELECTION
			if [ "$USERSELECTION" == "" ]; then
				CONFIGURE_TARGET_DEVICE="AV3XX"
			else
				if [ $USERSELECTION == 1 ]; then
					CONFIGURE_TARGET_DEVICE="AV3XX"
				fi
				if [ $USERSELECTION == 2 ]; then
					CONFIGURE_TARGET_DEVICE="GMINI4XX"
				fi
			fi
		done
fi

# this section of the script asks all of the yes or no querys, they are of the following format:
# CONFIG_QUERY_YN $variable_to_set "question to ask" "default answer"
# variable_to_set=$?

CONFIG_QUERY_YN $CONFIGURE_CHK_BAT_POWER "CHK_BAT_POWER? note: this must be yes atm, it is used to turn off lcd, HD and device" "y"
CONFIGURE_CHK_BAT_POWER=$?

CONFIG_QUERY_YN $CONFIGURE_CHK_USB_FW "CHK_USB_FW? note: if you choose no, HD timer might mess with USB when USB is plugged and enable" "y"
CONFIGURE_CHK_USB_FW=$?

CONFIG_QUERY_YN $CONFIGURE_HAVE_EXT_MODULE "HAVE_EXT_MODULE? (AV1xx/AV3xx/JBMM only)" "y"
CONFIGURE_HAVE_EXT_MODULE=$?

CONFIG_QUERY_YN $CONFIGURE_HAVE_FM_REMOTE "HAVE_FM_REMOTE?" "y"
CONFIGURE_HAVE_FM_REMOTE=$?

CONFIG_QUERY_YN $CONFIGURE_HAVE_MAS_SOUND "HAVE_MAS_SOUND? (AV1xx/AV3xx/JBMM only)" "y"
CONFIGURE_HAVE_MAS_SOUND=$?

CONFIG_QUERY_YN $CONFIGURE_HAVE_AIC23_SOUND "HAVE_AIC23_SOUND? (Gmini4xx only)" "y"
CONFIGURE_HAVE_AIC23_SOUND=$?

CONFIG_QUERY_YN $CONFIGURE_HAVE_CMD_LINE "HAVE_CMD_LINE?" "y"
CONFIGURE_HAVE_CMD_LINE=$?

CONFIG_QUERY_YN $CONFIGURE_HAVE_EVT "HAVE_EVT?" "y"
CONFIGURE_HAVE_EVT=$?

CONFIG_QUERY_YN $CONFIGURE_HAVE_DVR "HAVE_DVR? (AV1xx/AV3xx/JBMM only)" "y"
CONFIGURE_HAVE_DVR=$?

echo ""
echo "-----------------------------------------"
echo ""

#we have all of our user input lets generate Makefile.conf
echo -n "Generating './Makefile.conf' ... "

#write out the generated portion of Makefile.conf
echo "#" >> ./Makefile.conf
echo "# This section was generated by the configure script" >> ./Makefile.conf
echo "#" >> ./Makefile.conf
echo "TARGET_DEVICE = $CONFIGURE_TARGET_DEVICE" >> ./Makefile.conf
echo "CHK_BAT_POWER = $CONFIGURE_CHK_BAT_POWER" >> ./Makefile.conf
echo "CHK_USB_FW = $CONFIGURE_CHK_USB_FW" >> ./Makefile.conf
echo "HAVE_EXT_MODULE = $CONFIGURE_HAVE_EXT_MODULE" >> ./Makefile.conf
echo "HAVE_FM_REMOTE = $CONFIGURE_HAVE_FM_REMOTE" >> ./Makefile.conf
echo "HAVE_MAS_SOUND = $CONFIGURE_HAVE_MAS_SOUND" >> ./Makefile.conf
echo "HAVE_AIC23_SOUND = $CONFIGURE_HAVE_AIC23_SOUND" >> ./Makefile.conf
echo "HAVE_CMD_LINE = $CONFIGURE_HAVE_CMD_LINE" >> ./Makefile.conf
echo "HAVE_EVT = $CONFIGURE_HAVE_EVT" >> ./Makefile.conf
echo "HAVE_DVR = $CONFIGURE_HAVE_DVR" >> ./Makefile.conf

#append our template to Makefile.conf
echo "#" >> ./Makefile.conf
echo "# This section is from Makefile.conf.template" >> ./Makefile.conf
echo "#" >> ./Makefile.conf
cat ./Makefile.conf.template >> ./Makefile.conf

#did everything work?
if [ -f "./Makefile.conf" ]; then
	echo "Done"
else
	echo "Error"
fi

exit